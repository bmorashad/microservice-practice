#/bin/bash

now=$(date +'%d-%m-%y-%H:%M')
if [ "$1" = "linkerd" ]; then
  ing=$(kubectl get ing -A | tail -n +2 | rg "linkerd" | awk '{print $5}')
  mesh=$(kubectl get ing -A | tail -n +2 | rg "linkerd" | awk '{print $1}' | rg ".*" -r "linkerd")
  resultFileName="$mesh-results/$mesh-results--epoch:$now"
  k6 run load_test.js --address localhost:6566 -e HOST=$ing -e MESH=$mesh --out json=$resultFileName
else
  ing=$(kubectl get ing -A | tail -n +2 | rg "istio" | awk '{print $5}')
  mesh=$(kubectl get ing -A | tail -n +2 | rg "istio" | awk '{print $1}' | rg ".*" -r "istio")
  resultFileName="$mesh-results/$mesh-results--epoch:$now"
  k6 run load_test.js --address localhost:6565 -e HOST=$ing -e MESH=$mesh --out json=$resultFileName
fi

