apiVersion: cloud.google.com/v1
kind: BackendConfig
metadata:
  name: random-product-gen-backendconfig
  namespace: {{.Values.mesh.namespace}}
spec:
  healthCheck:
    checkIntervalSec: 15
    timeoutSec: 15
    healthyThreshold: 1
    unhealthyThreshold: 2
    type: HTTP
    requestPath: /ping
    port: 7010
---
apiVersion: v1
kind: Service
metadata:
  name: random-product-gen
  namespace: {{.Values.mesh.namespace}}
  annotations:
    cloud.google.com/backend-config: '{"default": "random-product-gen-backendconfig"}'
    # cloud.google.com/app-protocols: '{"https":"HTTPS"}'
spec:
  type: NodePort
  ports:
    - name: "http-random-product-gen"
      port: 7010
      targetPort: 7010
      protocol: TCP
    - name: "http-random-prodcut-gen-pprof"
      port: 7012
      targetPort: 7012
      protocol: TCP
  selector:
    app: random-product-gen
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: random-product-gen
  namespace: {{.Values.mesh.namespace}}
  labels:
    app: random-product-gen
spec:
  replicas: 1
  selector:
    matchLabels:
      app: random-product-gen
  # strategy:
  #   type: Recreate
  template:
    metadata:
      labels:
        app: random-product-gen
      annotations:
      {{if eq .Values.mesh.namespace "linkerd-benchmark"}}
        config.linkerd.io/proxy-cpu-limit: 1000m
        config.linkerd.io/proxy-cpu-request: 1000m
        config.linkerd.io/proxy-memory-limit: 2.5Gi
        config.linkerd.io/proxy-memory-request: 2Gi
      {{end}}
      {{if eq .Values.mesh.namespace "istio-benchmark"}}
        sidecar.istio.io/proxyCPULimit: 1000m
        sidecar.istio.io/proxyCPU: 1000m
        sidecar.istio.io/proxyMemoryLimit: 2.5Gi
        sidecar.istio.io/proxyMemory: 2Gi
      {{end}}
    spec:
      containers:
        # - env:
        #     - name: DB_NAME
        #       value: ecommerce
        #     - name: DB_PORT
        #       value: "3306"
        #     - name: HOST
        #       # value: 192.168.58.2
        #       value: db
        #     - name: MYSQL_PASSWORD
        #       value: root
        #     - name: MYSQL_USER
        #       value: root
        #     - name: PPROF_PORT
        #       value: "8012"
        #     - name: SERVER_PORT
        #       value: "8010"
        - image: mohammedrashad/random-product-gen:5
          name: image-radnom-product-gen
          ports:
            - containerPort: 7010
              protocol: TCP
            - containerPort: 7012
              protocol: TCP
          envFrom:
            - configMapRef:
                name: config-server
          livenessProbe:
            httpGet:
              path: /ping
              port: 7010
            initialDelaySeconds: 60
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /ping
              port: 7010
            initialDelaySeconds: 60
            periodSeconds: 5
      restartPolicy: Always
      tolerations:
      - key: "app-family"
        operator: "Equal"
        value: {{.Values.mesh.appFamily}}
        effect: "NoSchedule"
